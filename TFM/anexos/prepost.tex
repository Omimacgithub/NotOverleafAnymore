\chapter{Modificaciones en el pre y postprocesado de modelos}
\label{chap:prepost}

Los pipelines de pre y postprocesado de los modelos suponen uno de los principales retos de los dispositivos Jetson, debido a limitada capacidad de procesamiento de las \acrshort{cpu} ARM, en este capítulo se exponen las soluciones aplicadas para mitigar el impacto computacional de dichos procesos en los modelos YOLO y OSNet.

\section{Postprocesado YOLO}
\label{sec:postyolo}

\section{Preprocesado OSNet}
\label{sec:preosnet}

Gracias a que se disponía del código de PyTorch del modelo, se ha podido integrar el pipeline de preprocesado de OSNet. El preprocesado de OSNet lleva a cabo las siguientes operaciones aplicadas a la imagen de entrada:
\begin{itemize}
    \item Intercambiar el orden de los canales de color (\acrshort{bgr} -> \acrshort{rgb}), ya que OpenCV trabaja con imágenes en \acrshort{bgr} y TensorRT con imágenes en \acrshort{rgb}.
    \item Reescalar la imagen a la resolución de entrada del modelo.
    \item Normalizar la imagen (dividir sus valores por 255, restar la media y dividir el resultado por la desviación típica).
    \item Intercambiar el orden de las dimensiones de la imagen: HWC (Height, Width, Channels) -> CHW, que es el modo que recomienda TensorRT para presentar los datos.
    \item Expandir una dimensión: CHW -> NCHW (donde N es el tamaño del \gls{batch}).
\end{itemize}

\input{contenido/codes/preosnet.tex}

El código \ref{coud:preosnet} muestra un extracto de la función \textit{forward} del modelo en el que se muestran las operaciones del preprocesado. Se han tenido que intercambiar funciones de OpenCV por alternativas integradas de los arrays de NumPy (ejemplo: cvtColor por permute), el reescalado de la imagen se ha dejado en el código de la inferencia.

Finalmente, se crea la instancia del modelo en PyTorch y se exporta mediante la función \textbf{torch.onnx.export}.

Es \textbf{muy importante} nombrar de forma única los \glspl{tensor} que se declaren, ya que especialmente en las últimas versiones de \gls{onnx} esto puede causar errores de \textbf{grafos acíclicos} en los modelos exportados.
\chapter{Pruebas y resultados del sistema completo}
\label{chap:systesting}

\lettrine{E}{n} este capítulo se exponen las pruebas y los resultados de rendimiento del sistema final.

\section{Introducción}
También se exponen resultados que prueban las capacidades del módulo adaptativo, se realiza un conjunto de pruebas con diferentes valores de parámetros para evaluar su impacto y por qué generan los resultados expuestos. Con el fin de obtener un sistema completamente autónomo, se ha estudiado varios métodos de inicialización de la base de datos, desde un método supervisado hasta uno totalmente controlado por el propio sistema. Se han comparado los resultados entre las diferentes inicializaciones y se ha explicado el motivo de los resultados y de los factores implicados. Debido a que el sistema se adapta a lo largo del tiempo, se han realizado pruebas que midan la consistencia del sistema a lo largo de varias repeticiones del video, para averiguar si este sufre de una caída repentina en el rendimiento por algún fallo del software. Todas las pruebas mencionadas se ejecutan en las modalidades \textit{Open-Set}, que detecta desconocidos y actualiza las entidades existentes y \textit{Open-World}, que realiza las mismas funciones que \textit{Open-Set}, pero con la capacidad de registrar a los desconocidos en el sistema. De este modo, se analizan las diferencias entre ambas modalidades.

\section{Datasets de las pruebas}
Las pruebas que analizan los métodos de inicialización y las capacidades del reconocimiento adaptativo se realizaron por separado del sistema bajo el modelo de reconocimiento facial \textbf{ArcFace}. Por lo tanto, para dichas pruebas se ha empleado el \gls{dataset} expuesto en la sección \ref{sec:modset}. En el caso que ocupa al sistema (pruebas de la sección \ref{sec:syscal}), se dispone de un \gls{dataset} que representa el \gls{gt} del nodo integración de sensores (ver sección \ref{sec:basearch}), ya que cada entrada del fichero es idéntica a la salida de dicho nodo. Cada entrada está compuesta por los siguientes objetos:
\begin{itemize}
    \item secs: \gls{timestamp} del tiempo de UNIX en segudos
    \item nsecs: \gls{timestamp} del tiempo en nanosegundos del segundo correspondiente al campo secs.
    \item people: lista de objetos, cada uno compuesto por los siguientes elementos:
          \begin{itemize}
              \item person\_id: etiqueta que identifica al usuario detectado (ejemplo: carlos)
              \item position: coordenadas del espacio \acrshort{3d} compartido por las cámaras y el \acrshort{lidar} en el que se sitúa dicho usuario.
          \end{itemize}
\end{itemize}

\section{Escalabilidad en el número de cámaras}
\label{sec:syscal}

Esta sección pretende evaluar el techo del sistema al elevar el número de cámaras implicadas.

Se inicializa el sistema con el nodo integración de sensores, el nodo \acrshort{lidar} y el número de nodos cámara deseado (ver sección \ref{sec:basearch}). Se reproduce el fichero rosbag una vez inicializado el sistema, que lo nutrirá con la información generada por los sensores en tiempo real. Cada predicción generada por el nodo integrador se almacena en memoria y se vuelca en un fichero \acrshort{json} una vez el sistema se detiene (por ejemplo, con un Ctrl-C). Los datos guardados en el fichero \acrshort{json} se procesan contra el \textit{\gls{dataset}} y se devuelven los resultados finales en forma de las siguientes métricas:

\begin{itemize}
    \item \textit{\textbf{Det precision}}: representa la precisión global de los modelos de detección.
    \item \textit{\textbf{Det recall}}: representa el \textit{recall} global de los modelos de detección.
    \item \textit{\textbf{Ident F1 score}}: corresponde con el \textit{F1\_score} global de los modelos de reconocimiento.
    \item \textit{\textbf{Ident precision}}: corresponde con la precisión global de los modelos de reconocimiento.
\end{itemize}

\subsection{Entorno de las pruebas}

La figura \ref{fig:systesting} ilustra el proceso comentado al inicio de la sección. Debido a que el rosbag utilizado es un archivo pesado (41 \acrshort{gb}), en ciertas situaciones ha sido necesario reproducir dicho fichero desde una \textbf{fuente externa} al no disponer de almacenamiento local suficiente. La comunicación con la fuente externa se realiza a través de una red \acrshort{lan} Gigabit Ethernet, que posee un ancho de banda limitado para la transmisión de imágenes \acrshort{rgbd}. La fuente externa debe de enviar $(|imagen\_RGB| + |imagen\_profundidad)*nºcams + |nube\_de\_puntos\_LiDAR|$ megabytes de datos cada 100 ms (que es la frecuencia a la que trabaja el sistema), siendo $|imagen\_RGB| = 40 MB/s$, $|imagen\_profundidad| = 20 MB/s$ y $|nube de puntos LiDAR| = 5 MB/s$, lo que supera el ancho de banda máximo (125 \acrshort{mb}/s) utilizando únicamente dos cámaras.

Para reducir el ancho de banda necesario para la transmisión, se ha optado por desplegar nodos encargados de comprimir la imagen \acrshort{rgb}. La compresión se realiza por medio del paquete \textit{image\_transport} de \acrshort{ros}, que logra reducir hasta 10 veces el tamaño de la imagen (resultando en 4 \acrshort{mb}/s). Los nodos cámara se suscriben al tópico con la imagen comprimida y se descomprime en el destino.

En el caso de la imagen de distancia, en sí no es un objeto pesado, por lo que no necesita compresión. Sin embargo, la frecuencia elevada de transmisión (30 Hz), hace que se requiera de un mayor ancho de banda. Como el resto de los sensores funcionan a 10 Hz, la tasa de la imagen de profundidad puede reducirse a dicha frecuencia, de forma que el sistema no nota el cambio y se logra reducir el ancho de banda. Con reducir la tasa de envío del nodo de \acrshort{ros} encargado de publicar la imagen sería suficientemente, pero debido a que el rosbag se grabó dicho nodo a 30 Hz, se ha optado por ejecutar el paquete \textit{topic\_tools} de \acrshort{ros}, que permite publicar una réplica de un tópico a una menor frecuencia.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/SYSTESTING.jpg}
    \caption{Reproducción y transmisión del rosbag por la red}
    \label{fig:systesting}
\end{figure}

\subsection{Resultados}

La tabla \ref{tab:scaleperf} muestra los resultados de los dispositivos en función del número de cámaras. Atendiendo a la tabla \ref{tab:scaleresources}, los recursos de la \acrshort{gpu} se llevan al límite con 10 cámaras en el caso de los equipos de sobremesa.

\input{contenido/tables/tests/scaleperf.tex}

\input{contenido/tables/tests/scaleresources.tex}

\input{contenido/tables/tests/scaleros2.tex}

En la tabla \ref{tab:scaleros2} se muestra el rendimiento del sistema en los dispositivos restantes. Los resultados mostrados no tienen en cuenta el nodo \acrshort{lidar} por los motivos comentados en la sección \ref{subsec:ROS2}. En estos dispositivos no es posible instalar \acrshort{ros} Noetic, al menos para poder contar con las últimas versiones del software de los mismos.

TODO: se ha conseguido optimizar YOLO en GPU, que suponía el cuello de botella del sistema para funcionar en tiempo real.

\section{Ajuste de parámetros del aprendizaje y reconocimiento}
\label{seq:paramtunning}

En esta sección se realiza un estudio acerca de la configuración óptima de parámetros en términos de rendimiento del sistema. A continuación se exponen los parámetros utilizados y su función, junto con el rango de valores para la prueba.

TODO: En la fase de inicialización de los modelos (o fase de entrenamiento), el sistema guarda la información estadística que representa a cierto modelo. Durante el funcionamiento del sistema, puede ocurrir que los datos que recibe de un individuo registrado varíen respecto a la información de entrenamiento, lo que se conoce como \textbf{concept drift}. Se debe de corregir el concept drift para evitar una pérdida en la precisión de reconocimiento.

TODO: actualización del modelo, añadir nuevas entidades puede corromper la información de las entidades iniciales (catastrophic forgetting).

\begin{itemize}
    \item \textbf{Umbral de Weibull (\textit{Tw})}: valor que determina si una entidad es desconocida o no. El rango probado es (0.05 0.1 0.25)
    \item \textbf{Percentil (\textit{percent})}: valor del percentil aplicado en la combinación de las puntuaciones generadas por las \acrshort{svm}. El rango probado es (0.25 0.5 0.75)
    \item \textbf{Número de \acrshort{svm} (\textit{max\_svm})}: valor que representa al tamaño máximo de un comité. El rango probado es (1 3 7 10)
    \item \textbf{Número de negativos (\textit{nneg})}: tamaño del conjunto de muestras negativas. El rango probado es (10 50)
    \item \textbf{Tamaño de la plantilla}: establece el número de frames positivos que define a un comité. Se va a partir siempre de un tamaño de 5 frames, el mínimo necesario acorde a \cite{Erik} para definir un nuevo individuo.
    \item \textbf{Tamaño de secuencia}: número de frames que forman una secuencia de video. Se ha fijado el valor en 15 frames, que equivalen a 1,5 segundos de video con cámaras funcionando a 10 Hz.
    \item \textbf{Solapamiento}: establece el salto en el número de frames entre secuencias. Se ha fijado el valor en 5, dando lugar a más secuencias para analizar al coincidir frames entre las mismas.
\end{itemize}

A continuación se exponen los resultados obtenidos para cada combinación en \textit{Open-Set} y \textit{Open-World} como una media de 5 ejecuciones. Se parte de \textbf{10 individuos registrados de antemano}, 6 de ellos presentes en el video de prueba. Se inicializa cada comité con 5 frames representativos.

\subsection{Modo \textit{Open-Set}}
\label{sec:osparams}

\input{contenido/tables/tests/osparams.tex}

La tabla \ref{tab:osparams} muestra los 5 mejores resultados de las pruebas del análisis de parámetros. Los parámetros \textit{percent} y \textit{nneg} muestran una tendencia clara a los valores 0.25 y 50 respectivamente. Al fusionar los scores de todas las SVM en todos los frames, se obtiene un único score acordado por la mayoría mediante la mediana, siendo esta equivalente al percentil 50. Al variar el percentil, el número de SVM participantes también varía. Un percentil de 100 implica obtener el mayor score, que se corresponde con la peor coincidencia (por ende, el valor de recall es paupérrimo, puesto que se necesita del consenso de todas las SVM del comité para devolver un match). Por otro lado, un percentil de 0 implica recuperar el score más bajo de entre todas las SVM en todos los frames. En este caso también podría darse un bajo recall ya que si por ejemplo se añade una SVM de otra entidad, dicha SVM devolvería un score negativo, por lo que Weibull etiquetaría el reconocimiento como desconocido al haber más de un comité activado. Según los resultados, el sistema se decanta por una participación minoritaria pero fiable, como los datos de precisión abalan. TODO: Se desconoce si el comité siempre utiliza las mismas \acrshort{svm} para los reconocimientos. Por otro lado, es más efectivo un tamaño de 50 del conjunto de negativos frente al valor de 10, esto se debe a que en dicho conjunto se albergan un mayor número de individuos, por lo tanto mejor se definen las fronteras de las \acrshort{svm}. En cuanto a los parámetros \textit{tw} y \textit{max\_svm} no existe una tendencia clara. Atendiendo a los valores de \textit{precision} y \textit{recall}, se puede apreciar como al aumentar el umbral de Weibull, el \textit{recall} aumenta en consecuencia a costa del \textit{precision}, esto se debe a que al aumentar el umbral se está agregando cierta tolerancia de la mejor puntuación a pertenecer a la distribución, por lo tanto menos desconocidos se detectan (aumenta el \textit{recall}) a costa de aceptar predicciones erróneas (baja la precisión), un valor bajo demuestra exactamente lo contrario. Un valor de 0.1 en el umbral es la opción más balanceada entre estas dos métricas, aunque los otros dos valores no reflejan resultados notablemente extremos. En cuanto al tamaño que conforma cada comité, puede afirmarse que un valor alto devuelve resultados más robustos, esto se debe a que se implica un mayor número de \acrshort{svm} en cada reconocimiento, lo que da lugar a más diversidad y por lo tanto a unos comités que se activan en una mayor cantidad de situaciones de la entidad.

\subsection{Modo \textit{Open-World}}

En el modo \textit{Open-World}, el sistema crea un nuevo comité cuando se reconoce a una nueva entidad en el sistema. Sin embargo, debido a las predicciones incorrectas del método, puede ocurrir que se creen nuevos comités para un individuo ya registrado. Estos nuevos comités pueden desplazar a los comités originales adueñándose de su identidad.

\input{contenido/tables/tests/owparams.tex}

Como en la sección \ref{sec:osparams}, en la tabla \ref{tab:owparams} se muestran los cinco mejores resultados fruto del análisis de parámetros.

Los parámetros \textit{nneg} y \textit{percent} permanecen constantes acorde a las pruebas de la sección \ref{sec:osparams}. A la hora de escoger un valor de umbral de Weibull (\textit{tw}) es necesario tener en cuenta una métrica adicional que es el número de comités que se han generado (se cuentan también los 10 comités iniciales). Un valor alto del umbral implica una reducción en la creación de comités, debido al elevado \textit{recall} y por ende a un menor número de desconocidos y recíprocamente. Al reducir el valor de \textit{tw} se elevan notablemente los comités creados, pasando de 8 a 24 comités sin contar los 10 iniciales, lo que implica un gran salto con apenas una reducción en el valor de \textit{recall}. Este crecimiento puede deberse a la indecisión del sistema de predecir un individuo, ya que al crear nuevos comités de la misma persona, aumenta el riesgo de que más de un comité se active (devuelva un score bajo), por lo que dejan de darse casos extremos, aumentando así el número de desconocidos y por ende de comités creados. En cuanto al parámetro \textit{max\_svm}, los resultados conducen a la misma conclusión que en las pruebas de la sección \ref{sec:osparams}, salvo por el valor de 3 en uno de los resultados, que representa una situación excepcional.

TODO: %\subsection{Umbral de actualización?}

TODO:\textbf{Umbral de actualización}: valor que se compara frente a la fusión de scores de una secuencia. El rango probado es (0.1 0.3)

TODO: Uno de los objetivos del sistema es obtener la mayor diversidad intra-comité y la mayor especificidad inter-comité. Un \textbf{percentil alto} encajaría si las SVM son \textbf{específicas} entre sí (la mayoría de las SVM devuelven match). En cambio, un \textbf{bajo percentil} funcionaría con unas SVM \textbf{más diversas} (se espera que la minoría de las SVM den un resultado coincidente).

TODO: En relación con el anterior punto, el número de SVM influye en la decisión de que percentil tomar. Si se utilizan 3 SVM por comité y la mediana, al menos 2 SVM deben de devolver un score bajo para dar un resultado coincidente. Por otro lado, si se utilizan 10 SVM y un percentil de 30, sólo 3 de las 10 SVM necesitan estar de acuerdo para devolver un match. En los resultados se muestra como un comité de 3 SVM y TW=0.05 destaca respecto a un comité de 1 SVM y TW=0.5. Los resultados utilizando 10 SVM por comité no llegan a mejorar notablemente el valor de 3 SVM, esto es de gran relevancia, puesto que se reduce el número de iteraciones de cada reconocimiento de 10*n a 3*n, siendo n el número de comités que existen y asumiendo que todos los comités han llegado al límite de SVM. Con estos resultados se ha demostrado que implementar varias SVM por comité mejora el recall manteniendo la precisión. 1 sóla SVM por comité es efectiva si dicha SVM es representativa del individuo, en caso contrario puede devolver respuestas coincidentes acerca de una entidad distinta del comité, generando ruido que perjudica a las predicciones de Weibull. Un mayor número de SVM combinado con el percentil devuelve un resultado conforme dicta un grupo que omite los scores de SVM intrusas (de entidades distintas) y permite expulsarlas mediante los criterios ya comentados en la sección \ref{seq:limmod}.

TODO: comentar como el solapamiento puede influir en la creación de nuevas SVM.

(TODO: podría comentarse) Criterio de selección de frames para nuevas SVM: también es muy importante la selección de las muestras que conforman las SVM, en la tabla (TODO) se muestran 2 criterios para la selección, uno consiste en seleccionar los frames con los scores más cercanos al cero, mientras que el otro es una selección aleatoria. El primer criterio demuestra un aumento en el F1 score, dado que los frames cercanos al cero son los más complicados de reconocer, de esta forma la SVM amplía sus fronteras respecto a lo que ya reconoce. A la hora de crear una SVM de un nuevo comité en el modo open-world, no queda otra alternativa que realizar una selección aleatoria.

\section{Influencia del número de usuarios en el rendimiento}
El número de usuarios registrados es un factor crítico, ya que el sistema implementado se nutre de los datos de los individuos. Por un lado, tener más individuos se traduce en más comités, por lo tanto se dispone de más puntos para definir la distribución de Weibull, lo que refuerza las predicciones. Por otra parte, se dispone de un mayor número de muestras negativas, lo que permite definir mejor las fronteras de las \acrshort{svm} y así mejorar la capacidad de predicción.

La calidad de la función de reconocimiento viene determinada por el número de puntos que componen la función de Weibull, cuantos más puntos, mayor definición y por tanto reconocimientos más precisos \cite{Erik}. Con un universo de 20 individuos, sólo 5 puntos componen la función de Weibull (de las 20 entidades sólo 10 se registran en el sistema, a modo de probar el open-set, y de esos 10, la mitad definen la función), lo que lleva a un comportamiento más impreciso que con un universo mayor. El sistema inicial cuenta con un universo de \textbf{6 individuos}, lo que claramente \textbf{es insuficiente} para realizar una diferenciación precisa de los IoI respecto a lo desconocido.

\section{Métodos de inicialización del sistema}

La selección de los frames que conforman un nuevo comité es un factor crítico para el correcto funcionamiento del sistema. En esta sección se evalúa el sistema en los modos \textit{Open-Set} y \textit{Open-World} aplicando 3 técnicas de inicialización:
\begin{itemize}
    \item \textbf{Supervisada}: los comités se inicializan con muestras (recortes faciales) seleccionadas de antemano por el operador. Es el modo utilizado en las pruebas de la sección \ref{seq:paramtunning}.
    \item \textbf{Semisupervisada}: se escoge un momento del video en el que aparece un mínimo de personas simultáneamente y se agrupan las muestras por individuo con la información del \gls{dataset}. Para los individuos que no hayan aparecido en ese instante, se inicializan sus comités por medio del método supervisado.
    \item \textbf{No supervisada}: se escoge un momento del video en el que aparece un mínimo de personas simultáneamente y se delega el agrupamiento al método de tracking implementado. Para los individuos que no hayan aparecido en ese instante, se ejecuta la prueba y se incluyen en el momento que se reconoce un desconocido (se apoya en la información del \gls{dataset} para asignarle la etiqueta que corresponde).
\end{itemize}
Para los modos semisupervisado y no supervisado se tiene que cumplir que el instante del video agrupe un número mínimo de personas y que se pueda extraer un número mínimo de caras para la inicialización. Adicionalmente, las muestras recolectadas deben de cumplir las siguientes condiciones:
\begin{itemize}
    \item Que la cara se encuentre enteramente dentro de la cámara.
    \item Que el ancho del recorte no supere al alto del recorte.
\end{itemize}
La situación ideal sería encontrar un instante en el que todas las personas del video aparezcan. Como mínimo para que el sistema se inicialice es necesario que aparezcan 5 entidades, que equivale al número mínimo de puntos necesarios para definir la distribución de Weibull. En el \gls{dataset} de prueba solo aparece un instante de 5 individuos que cumpla con las condiciones anteriores. Por lo tanto, es necesario añadir a la entidad restante a partir de los datos registrados en el caso de la inicialización no supervisada.

\subsection{Modo \textit{Open-Set}}

\input{contenido/tables/tests/osinittab.tex}

En la tabla \ref{tab:osinittab} se muestran los resultados según la inicialización. Se puede apreciar como claramente el modo supervisado es el que mejor funciona, ya que los recortes de caras pudieron ser seleccionados minuciosamente, por lo que es lógico que devuelva el mejor resultado. El modo semisupervisado . Por último, el modo no supervisado refleja el peor rendimiento, en comparación con el modo semisupervisado los comités deberían de ser los mismos, ya que no existen muchos instantes en el video de prueba que reúnan las condiciones requeridas, por lo que el problema podría residir en como el método de tracking realiza el agrupamiento. Por otra parte, la caída en la precisión y la excesiva desviación en las métricas se debe al individuo que se incluye durante la operación del sistema, a diferencia de los anteriores modos, el comité de la persona en cuestión se define en base a unas muestras no seleccionadas de antemano, por lo que los resultados varían dependiendo de la calidad de las muestras que el sistema escoja. También se depende de que el desconocido detectado sea realmente el individuo en cuestión, en caso contrario se crea un comité que se adueña de la identidad del sujeto, agregando así ruido a los reconocimientos. TODO: el umbral de Weibull.

\subsection{Modo \textit{Open-World}}

\input{contenido/tables/tests/owinittab.tex}

En la tabla \ref{tab:owinittab} se muestran los resultados esta vez para \textit{Open-World}. Salvo en el modo no supervisado, se obtienen mejores resultados con un \textit{Tw} de 0.25 respecto a 0.1, esto puede deberse a que el sistema es menos propenso a crear comités que se puedan adueñar de las entidades existentes, por lo tanto se genera una menor confusión y equivocación. TODO: analizar porque el \textit{Tw} da mejor en 0.1. El número de comités aumenta en el modo no supervisado, ya que al contar con muestras de peor calidad (generalmente) la confusión inter-comité aumenta.

\section{Evolución del sistema en el tiempo}
\subsection{Modo \textit{Open-Set}}

La figura \ref{fig:osevol}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/figaro.png}
    \caption{Diagrama con datos de ejemplo.}
    \label{fig:osevol}
\end{figure}

\subsection{Modo \textit{Open-World}}
\chapter{Pruebas y resultados del sistema extendido}
\label{chap:systesting}

\lettrine{E}{n} este capítulo se exponen las pruebas y los resultados que miden las capacidades de los nuevos componentes implementados.

\section{Introducción}

En esta sección se introducen las pruebas escogidas para medir las capacidades del reconocimiento adaptativo desarrollado, en concreto las siguientes:

\begin{itemize}
    \item \textbf{Ajuste de parámetros:} se realiza un conjunto de pruebas con diferentes valores de parámetros para evaluar su impacto y por qué generan los resultados expuestos.
    \item \textbf{Inicialización de personas registradas:} se ha estudiado varios métodos de inicialización de la base de datos, desde un método semisupervisado hasta uno totalmente controlado por el propio sistema (no supervisado). Se han comparado los resultados entre las diferentes inicializaciones TODO: y se ha realizado una discusión.
\end{itemize}

Todas las pruebas mencionadas se ejecutan en las modalidades \textbf{\textit{Open-Set}}, que en este caso \textbf{detecta desconocidos y actualiza las entidades existentes}\footnote{en un sistema tipo \textit{Open-Set}, no se aplica la actualización de las entidades existentes} y \textbf{\textit{Open-World}}, que realiza las mismas funciones que \textit{Open-Set}, pero con la capacidad de \textbf{registrar a los desconocidos en el sistema}.

\section{Realización de las pruebas}

Las pruebas que analizan los nuevos componentes se realizaron por separado del sistema bajo el modelo de reconocimiento facial \textbf{ArcFace}. Por lo tanto, para dichas pruebas se ha empleado el \gls{dataset} expuesto en la sección \ref{sec:modset}.

Las pruebas siguen el mismo procedimiento que el expuesto en la sección \ref{sec:probes} para los modelos de reconocimiento, salvo por los siguientes cambios:

\begin{itemize}
    \item Los frames se procesan \textbf{por bloques}, de forma que se agrupan las \glspl{bbox} según el individuo mediante la técnica de procesamiento de video (sección \ref{sec:video}), se obtienen los \glspl{embedding} por medio de ArcFace y se aplica el reconocimiento adaptativo para reconocer a las personas de la secuencia.
    \item Se devuelven las métricas de \textbf{\textit{precision}, \textit{recall}} y \textbf{\textit{F1\_score}}, en vez de únicamente la métrica \textit{precision} para evaluar los reconocimientos. En el apéndice \ref{subsec:recon} se explican estas métricas en detalle.
\end{itemize}

\section{Ajuste de parámetros del aprendizaje y reconocimiento}
\label{seq:paramtunning}

En esta sección se realiza un estudio acerca de la configuración óptima de parámetros en términos de rendimiento del sistema. A continuación, se exponen los parámetros utilizados y su función, junto con el rango de valores para la prueba.

\begin{figure}
    \centering
    \includegraphics[width=0.75\linewidth]{imagenes/SOLAPING.jpg}
    \caption{Ejemplo de funcionamiento del parámetro \textit{step\_size}}
    \label{fig:SOLAPING}
\end{figure}

\begin{itemize}
    \item \textbf{Umbral de Weibull (\textit{Tw})}: valor que determina si una entidad es desconocida o no. El rango probado es (0.05 0.1 0.25), (TODO: coherente?) no se ha decidido explorar valores más altos debido al impacto en la precisión como se verán más adelante.
    \item \textbf{Percentil (\textit{percent})}: valor del percentil aplicado en la combinación de las puntuaciones generadas por las \acrshort{svm}. El rango probado es (0.25 0.5 0.75).
    \item \textbf{Número de \acrshort{svm} (\textit{max\_svm})}: valor que representa el tamaño máximo de un comité. El rango probado es (1 3 7 10),  valores más altos implicarían un mayor coste computacional en cada iteración.
    \item \textbf{Número de negativos (\textit{nneg})}: tamaño del conjunto de muestras negativas. El rango probado es (10 50). No se han podido probar valores más altos, debido a la escasez de muestras disponibles.
    \item \textbf{Tamaño de la plantilla}: establece el número de frames positivos que define a un comité. El tamaño se ha fijado en 5 frames, ya que se ha demostrado que otorga buen rendimiento, al mismo tiempo que utiliza el mínimo de muestras posibles \cite{5samples}.
    \item \textbf{Tamaño de secuencia (\textit{frame\_block})}: número de frames que forman una secuencia de video. Se ha fijado el valor en 15 frames, que equivalen a 1,5 segundos de video con cámaras funcionando a 10 Hz.
    \item \textbf{Tamaño de salto (\textit{step\_size})}: establece el salto en el número de frames entre secuencias. Gracias a este parámetro, se obtiene un mayor número de secuencias a partir de un mismo video de prueba. La figura \ref{fig:SOLAPING} muestra un ejemplo con tamaño de secuencia 15 y valor de \textit{step\_size} de 5 (que es el que se va a mantener para las pruebas).
\end{itemize}

A continuación se exponen los resultados obtenidos para cada combinación en \textit{Open-Set} y \textit{Open-World} como una media de 5 ejecuciones. Se parte de \textbf{10 individuos registrados de antemano}, 6 de ellos presentes en el video de prueba. Se inicializa cada comité con 5 frames representativos (que corresponde con el \textbf{tamaño de la plantilla}).

\subsection{Modo \textit{Open-Set}}
\label{sec:osparams}

\input{contenido/tables/tests/osparams.tex}

La tabla \ref{tab:osparams} muestra los 5 mejores resultados de las pruebas del análisis de parámetros ordenados según la métrica \textit{F1\_score}.

El parámetro \textbf{\textit{percent}} muestra una tendencia clara al valor \textbf{0.25}. Un percentil de 0.25 implica escoger las 2/3 primeras \acrshort{svm} para otorgar la puntuación final del comité. Los \textbf{valores extremos} en el percentil implican en un \textbf{bajo \textit{recall}}, un percentil de 100 implica obtener el mayor valor (que se corresponde con la peor coincidencia), este valor puede proceder de una \acrshort{svm} "intrusa" (de otro individuo), que hace que el comité no se active ante sus muestras. Lo mismo sucede con un percentil de 0, si por ejemplo se añade una \acrshort{svm} que corresponde a otro comité, la \acrshort{svm} se activaría ante las muestras que pertenecen a ese comité. En ambos casos se tendría una situación de 2 comités activados, lo que resultaría en un \textbf{desconocido} cuando realmente no lo es.

Para el parámetro \textbf{\textit{nneg}} se considera más efectivo un tamaño de 50 del conjunto de negativos frente al valor de 10, ya que con 50 muestras se puede albergar un \textbf{mayor número de individuos}, la \acrshort{svm} puede definir mejor el hiperplano que separa las muestras positivas de las negativas, luego su \textbf{poder discriminatorio aumenta}.

En cuanto al valor del parámetro \textbf{\textit{Tw}} no existe una tendencia clara. Atendiendo a los valores de \textit{precision} y \textit{recall}, se puede apreciar como al \textbf{aumentar el umbral de Weibull}, el \textbf{\textit{recall} aumenta a costa de la precisión}. Debido a que se está agregando cierta tolerancia de la mejor puntuación a pertenecer a la distribución de puntuaciones no coincidentes, por lo tanto, \textbf{menos desconocidos} se detectan (aumenta el \textit{recall}) a costa de aceptar un mayor número de \textbf{predicciones erróneas} (baja la precisión), un valor bajo demuestra justo lo contrario. Un valor de \textbf{0.1} parece ser la opción \textbf{más balanceada} entre un excelente \textit{recall} y una excelente precisión.

En el caso del parámetro \textbf{\textit{max\_svm}}, tampoco es seguro qué único valor escoger. Puede afirmarse que un valor alto devuelve resultados más robustos, esto se debe a que se implica un mayor número de \acrshort{svm} en cada reconocimiento, lo que da lugar a más diversidad y por lo tanto a unos comités que se activan en una mayor cantidad de diversas situaciones de la entidad.

\subsection{Modo \textit{Open-World}}

Como ya se comentó en la sección \ref{sec:incrtypes}, en el modo \textit{Open-World} el sistema añade nuevo conocimiento de forma incremental, adaptándose al nuevo contexto y realizando así mejores predicciones.

\input{contenido/tables/tests/owparams.tex}

Al igual que en la sección \ref{sec:osparams}, en la tabla \ref{tab:owparams} se muestran los cinco mejores resultados, ordenados acorde al \textbf{\textit{F1\_score}}.

Los parámetros \textbf{\textit{nneg}} y \textbf{\textit{percent}} permanecen constantes, acorde a las pruebas de la anterior sección.

A la hora de escoger un valor de \textbf{\textit{Tw}}, es necesario tener en cuenta una métrica adicional, que es el \textbf{número de comités} que se han generado (\textit{Number of ensembles} en la tabla \ref{tab:owparams}), contando los 10 comités iniciales. Un \textbf{valor alto del umbral} implica una \textbf{reducción} en la creación de \textbf{comités}, debido al \textbf{elevado \textit{recall}} y por ende a un \textbf{menor número de desconocidos}. Al \textbf{reducir el valor de \textit{Tw}}, se \textbf{elevan notablemente} los \textbf{comités} creados, pasando de 18 a 34 comités, lo que es \textbf{problemático} para este sistema, ya que no posee la capacidad de \textbf{asociar los nuevos comités} a los ya existentes (en esta prueba, todas las entidades son conocidas), por lo que aumenta el riesgo de que más de un comité se active, dando el reconocimiento como \textbf{desconocido}.

En cuanto al parámetro \textbf{\textit{max\_svm}}, los resultados conducen a la misma conclusión que en las pruebas de la sección \ref{sec:osparams}, salvo por el valor de 3 en uno de los resultados, que implica que el sistema prefiere un valor de \textit{Tw} de 0.25, aunque solo opere con 3 \acrshort{svm}s por comité (realmente 1 \acrshort{svm}, por el percentil 25).

%TODO:\textbf{Umbral de actualización}: valor que se compara frente a la fusión de scores de una secuencia. El rango probado es (0.1 0.3)

\subsection{Discusiones}
\label{sec:discusparamtunning}

Los resultados de precisión en el modo \textit{Open-World} son claramente \textbf{inferiores} al modo \textit{Open-Set}.

%TODO: no lo creo, sino como se explica la subida en el recall???? Creo q el sistema es capaz de crear comités que se ajusten mejor a las situaciones concretas del individuo que con el comité original no sucede (ejemplo: una determinada orientación de la cara), esto quiere decir que . El principal factor de esta caída es la existencia de \textbf{comités duplicados} para un individuo, lo que aumenta las probabilidades de otorgar un reconocimiento \textbf{desconocido}. Para colmo, cabe la posibilidad de que las \acrshort{svm} que pertenecen a los comités duplicados se entrenen con muestras del \textbf{mismo individuo} en los conjuntos \textbf{positivo y negativo}, lo que podría \textbf{anular el poder discriminatorio} de dichas \acrshort{svm}, lo que implica en una \textbf{pérdida de precisión}. Por otro lado, el \textit{recall} aumenta, precisamente por la creación de nuevos comités, que a.

Por los motivos ya comentados, es necesario implementar un método que permita \textbf{asociar comités duplicados} y/o mejorar el reconocimiento por medio del \acrfull{evt}.

El valor del parámetro \textbf{\textit{Tw}} es \textbf{clave} para el correcto funcionamiento del sistema, mientras que en el modo \textit{Open-Set} un valor bajo de este parámetro resulta en un balance muy favorable para la precisión y el \textit{recall}, en el modo \textit{Open-World} es \textbf{perjudicial} para ambas métricas, debido a que fomenta la creación de comités duplicados. En cambio, un \textbf{valor alto} de este parámetro en el modo \textbf{\textit{Open-World}}, aunque a priori sea negativo para la precisión, es la \textbf{mejor opción} para reducir la creación de comités duplicados.

Uno de los objetivos del sistema es obtener la \textbf{mayor diversidad intra-comité} y la \textbf{mayor especificidad inter-comité}, de esta forma, el comité responde a la mayor variedad de situaciones de su entidad, mientras que no se activa ante otros individuos. En este sistema las \acrshort{svm} creadas \textbf{son muy parecidas entre sí}, dando lugar a poca información nueva del individuo, esto se debe principalmente al \textbf{\textit{step\_size}} introducido en las pruebas, que hace que se incluyan los mismos frames entre \acrshort{svm}s. Esto podría explicar el valor de 3 en el parámetro \textbf{\textit{max\_svm}} en la tabla \ref{tab:owparams}.

Finalmente, acorde a los resultados obtenidos en esta sección, se establecen los siguientes valores de parámetros que aplican para el resto de pruebas de este capítulo:
\begin{itemize}
    \item \textbf{\textit{max\_svm}}: 10
    \item \textbf{\textit{percent}}: 0.25
    \item \textbf{\textit{nneg}}: 50
\end{itemize}

Debido a la influencia del parámetro \textbf{\textit{Tw}} en los resultados, se seguirán realizando pruebas con diferentes valores del mismo.

%Un \textbf{percentil alto} encajaría si las SVM son \textbf{específicas} entre sí (la mayoría de las SVM devuelven match). En cambio, un \textbf{bajo percentil} funcionaría con unas SVM \textbf{más diversas} (se espera que la minoría de las SVM den un resultado coincidente).

%TODO: En relación con el anterior punto, el número de SVM influye en la decisión de que percentil tomar. Si se utilizan 3 SVM por comité y la mediana, al menos 2 SVM deben de devolver un score bajo para dar un resultado coincidente. Por otro lado, si se utilizan 10 SVM y un percentil de 30, sólo 3 de las 10 SVM necesitan estar de acuerdo para devolver un match. En los resultados se muestra como un comité de 3 SVM y TW=0.05 destaca respecto a un comité de 1 SVM y TW=0.5. Los resultados utilizando 10 SVM por comité no llegan a mejorar notablemente el valor de 3 SVM, esto es de gran relevancia, puesto que se reduce el número de iteraciones de cada reconocimiento de 10*n a 3*n, siendo n el número de comités que existen y asumiendo que todos los comités han llegado al límite de SVM. Con estos resultados se ha demostrado que implementar varias SVM por comité mejora el recall manteniendo la precisión. 1 sóla SVM por comité es efectiva si dicha SVM es representativa del individuo, en caso contrario puede devolver respuestas coincidentes acerca de una entidad distinta del comité, generando ruido que perjudica a las predicciones de Weibull. Un mayor número de SVM combinado con el percentil devuelve un resultado conforme dicta un grupo que omite los scores de SVM intrusas (de entidades distintas) y permite expulsarlas mediante los criterios ya comentados en la sección \ref{seq:limmod}.

%El número de usuarios registrados es un factor crítico, ya que el sistema implementado se nutre de los datos de los individuos. Por un lado, tener más individuos se traduce en más comités, por lo tanto se dispone de más puntos para definir la distribución de Weibull, lo que refuerza las predicciones. Por otra parte, se dispone de un mayor número de muestras negativas, lo que permite definir mejor las fronteras de las \acrshort{svm} y así mejorar la capacidad de predicción.

%La calidad de la función de reconocimiento viene determinada por el número de puntos que componen la función de Weibull, cuantos más puntos, mayor definición y por tanto reconocimientos más precisos \cite{Erik}. Con un universo de 20 individuos, solo 5 puntos componen la función de Weibull (de las 20 entidades solo 10 se registran en el sistema, a modo de probar el open-set, y de esos 10, la mitad definen la función), lo que lleva a un comportamiento más impreciso que con un universo mayor. El sistema inicial cuenta con un universo de \textbf{6 individuos}, lo que claramente \textbf{es insuficiente} para realizar una diferenciación precisa de los IoI respecto a lo desconocido.

\section{Métodos de inicialización del sistema}

La selección de los frames que conforman los comités iniciales es un factor \textbf{crítico} para el correcto funcionamiento del sistema (como se demuestra en \cite{5samples}). En esta sección se evalúa el sistema en los modos \textit{Open-Set} y \textit{Open-World} en las 2 técnicas de inicialización vistas en la sección \ref{sec:initieing}, más una adicional que se exponen a continuación:

\begin{itemize}
    \item \textbf{Semisupervisada}: los comités se inicializan con muestras (recortes faciales o \glspl{bbox}) seleccionadas de antemano por el operador. Es el modo utilizado en las pruebas de la sección \ref{seq:paramtunning}.
    \item \textbf{No supervisada}: se escoge un momento del video en el que aparece un mínimo de personas simultáneamente y se delega el agrupamiento de muestras al \textbf{módulo de procesamiento de video} implementado (ver sección \ref{sec:video}). Para los individuos que no hayan aparecido en ese instante, se ejecuta la prueba y se incluyen durante la operación del sistema (se apoya en la información del \gls{dataset} para asignarle la etiqueta que corresponde).
    \item \textbf{No supervisada con apoyo del \gls{dataset}}: se escoge un momento del video en el que aparece un mínimo de personas simultáneamente y se agrupan las muestras a partir de la \textbf{información del \gls{dataset}}. Para los individuos que no hayan aparecido en ese instante, se inicializan sus comités por medio de la técnica \textbf{semisupervisada}. El objetivo de probar esta técnica es establecer una \textbf{línea base} en la que medir el funcionamiento del procesamiento de video y de la inclusión de nuevos usuarios de la técnica no supervisada.
\end{itemize}
Para ambas técnicas no supervisadas, se tiene que cumplir que el instante del video agrupe un \textbf{número mínimo de 5 personas} y que se pueda extraer un \textbf{mínimo de 5 muestras} de cada para la inicialización. Adicionalmente, las muestras recolectadas deben de cumplir las siguientes condiciones:
\begin{itemize}
    \item Que la cara se encuentre enteramente dentro de la cámara.
    \item Que el ancho de la \gls{bbox} no supere al alto de la \gls{bbox}.
\end{itemize}
%La situación ideal sería encontrar un instante en el que todas las personas del video (6 en total) aparezcan. Como mínimo para que el sistema se inicialice es necesario que aparezcan 5 entidades, que equivale al número mínimo de puntos necesarios para definir la distribución de Weibull. En el \gls{dataset} de prueba solo aparece un instante de 5 individuos que cumpla con las condiciones anteriores. Por lo tanto, es necesario añadir a la entidad restante durante la inferencia en el caso de la técnica no supervisada.

Para mostrar el notorio impacto del parámetro \textbf{\textit{Tw}} en los resultados, se han probado los valores \textbf{0.25} y \textbf{0.1} para cada una de las 3 técnicas en ambas modalidades \textit{Open-Set} y \textit{Open-World}. A continuación se muestran los resultados de las 3 técnicas para dichos modos.

\subsection{Modo \textit{Open-Set}}

\input{contenido/tables/tests/osinittab.tex}

En la tabla \ref{tab:osinittab} se muestran los resultados para los 3 tipos de inicialización.

\begin{figure}[tbp]
    \centering
    \begin{subfigure}[t]{0.3\textwidth}
        \includegraphics[width=\textwidth]{imagenes/supervised.jpg}
        \caption{modo semisupervisado/\\no supervisado + \gls{dataset}}
    \end{subfigure}
    \begin{subfigure}[t]{0.3\textwidth}
        \includegraphics[width=\textwidth]{imagenes/nosupervised.jpg}
        \caption{modo no supervisado/\\no supervisado + \gls{dataset}}
    \end{subfigure}
    \caption{Conjuntos de muestras según la inicialización}
    \label{fig:inits}
\end{figure}

La figura \ref{fig:inits} expone un ejemplo de las muestras recogidas según la técnica. En la izquierda, puede verse que las muestras tienen una buena resolución, apenas poseen borrosidad, contienen suficiente luminosidad y son todas caras frontales, justo lo contrario que las muestras de la derecha.

Las muestras del modo semisupervisado permiten al sistema responder a mayor variedad de condiciones del individuo, por lo tanto es el que mejores resultados arroja.

Atendiendo a los modos no supervisados, se puede ver una pérdida clara en el rendimiento, que se debe principalmente a la selección de las muestras.

%Debido a que el método no supervisado utiliza el procesamiento de video, es esperable que las muestras no varíen entre sí, puesto que así ocurre en frames consecutivos.

Por último, el modo no supervisado refleja el peor rendimiento. La caída en la precisión y la excesiva desviación en las métricas se debe al individuo que se incluye durante la operación del sistema, a diferencia de los anteriores modos. También se depende de que el desconocido detectado sea realmente el individuo en cuestión, en caso contrario se crea un comité que se adueña de la identidad del sujeto, agregando así ruido a los reconocimientos. TODO: comentar diferencias respecto al umbral de Weibull.

\subsection{Modo \textit{Open-World}}

\input{contenido/tables/tests/owinittab.tex}

En la tabla \ref{tab:owinittab} se muestran los resultados esta vez para \textit{Open-World}.

Se puede apreciar una caída en la precisión en las técnicas no supervisadas, mayor que en el modo \textit{Open-Set}. Al contar con muestras de peor calidad respecto a la técnica semisupervisada, es más difícil que los comités se activen ante nuevas muestras de su individuo, lo que genera confusión en el sistema y por tanto un mayor número de desconocidos (TODO: pero el recall es espectacular)
%El número de comités aumenta en el modo no supervisado, ya que al contar con muestras de peor calidad (generalmente) la confusión inter-comité aumenta.

Como se comentó en la discusión de las pruebas de parámetros (sección \ref{sec:discusparamtunning}), el valor de 0.25 del parámetro \textit{Tw} otorga los mejores resultados en \textit{Open-World}, debido a que con 0.1 se crea casi el \textbf{doble de comités} en los casos no supervisados, cuya mayoría son duplicados que añaden incertidumbre al sistema. Se puede apreciar en el modo semisupervisado como se reduce tanto el número de comités creados como la desviación en su número, ya que TODO.
\chapter{Arquitectura del sistema propuesto}
\label{chap:sysarch}
\lettrine{E}{n} este capítulo se expone una idea general de la arquitectura planteada y se comentan sus componentes en detalle.

Este proyecto parte de un sistema que detecta y reconoce personas a partir de la información de diferentes sensores, de forma que se obtienen reconocimientos robustos y persistentes en el tiempo \cite{andrew}.

El funcionamiento se muestra en la figura \ref{fig:finalsys}. Los nuevos componentes desarrollados se encuentran marcados en negrita, mientras que el resto de la arquitectura sigue la estructura de \cite{andrew}. El sistema puede tener 1 o varias cámaras en ejecución, que envían sus imágenes a un nodo encargado de su procesamiento (nodo cámara). Cada nodo cámara recibe los datos \textbf{de una sola cámara}, que devuelve una lista de predicciones de los individuos captados por dicha cámara. Cada detección se etiqueta con su posición \acrshort{3d} a partir de la imagen de distancias de la cámara. Los resultados obtenidos de la anterior fase se contrastan con las detecciones realizadas por un modelo que procesa una \gls{pcl} otorgada por un sensor \acrshort{lidar} (nodo \acrshort{lidar}). Finalmente, las salidas de todos los nodos se fusionan para reforzar las predicciones (nodo integración de sensores).

El nodo cámara realiza un agrupamiento de los frames en secuencias (o videos) con el fin de explotar la coherencia espacio-temporal. Los modelos \acrshort{cnn} de detección reciben dicha secuencia de frames y devuelven los recortes (o \glspl{bbox}) con las detecciones, que son agrupados por individuo aplicando un método de seguimiento (tracking). Los recortes de caras y cuerpos se transforman en vectores de características a partir de los respectivos modelos de reconocimiento, que a su vez sirven de entrada para el módulo adaptativo, que toma la decisión de reconocimiento y actualiza la base de datos de personas registrada.

El módulo adaptativo es el encargado de otorgar el reconocimiento \textit{Open-Set} y/o \textit{Open-World}. Dicho módulo evalúa si la persona detectada en la secuencia es un desconocido o pertenece a la base de datos. En ambos casos, el sistema se actualiza con la nueva información en forma de un nuevo registro en el sistema si es un desconocido o modificando el registro existente ante los cambios de la entidad (lo que se conoce como \textit{\textbf{concept-drift}}).

Toda la arquitectura vista se ejecuta en el \textit{framework} \acrshort{ros} \cite{ROS}. \acrshort{ros} se encarga de crear los procesos para cada nodo, comprobar su estado, regular la frecuencia a la que trabajan, crear la red en la que dichos procesos intercambian mensajes, entre otros muchos detalles que resultan transparentes para el programador.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/FINALSYS.jpg}
    \caption{Arquitectura general del sistema, los módulos en negrita se corresponden con los nuevos componentes desarrollados.}
    \label{fig:finalsys}
\end{figure}

\section{Procesamiento de video}
\label{sec:video}
El sistema de partida trabaja a nivel de frame \cite{andrew}, es decir, devuelve predicciones de los individuos presentes en una sola imagen. Esta aproximación permite trabajar a altas frecuencias (ejemplo: devolver una predicción acerca de una persona cada 100 ms), sin embargo, las predicciones dependen enteramente de la calidad del frame (ejemplo: nivel de borrosidad). En este proyecto se ha optado por trabajar con \textbf{secuencias de frames (o video)}, de esta forma, se devuelve un reconocimiento más robusto basado en la coherencia espacio-temporal. Simplemente consiste en procesar un conjunto de frames en un intervalo de tiempo, dicho intervalo es ajustable según las necesidades del operador (ejemplo: intervalo de 1 segundo). De los frames del intervalo, se extrae la información de los individuos presentes a partir de un modelo de detección de caras (YuNet) y/o de cuerpos (YOLO) y se agrupan por cada individuo a lo largo del intervalo, de modo que los frames que no contienen sujetos \textbf{se descartan}.

\subsubsection{Seguimiento de entidades}
En casos como los del \textit{\gls{dataset}} FACE COX \cite{cox}, donde en los videos siempre aparece una sola persona, la agrupación de las entidades es trivial. Sin embargo, en un video donde aparecen múltiples individuos que se entrecruzan, es necesario adoptar un método para seguir el rastro de cada persona entre frames.

El \textbf{método húngaro} es un algoritmo que resuelve el problema de la asignación óptima. Dada una matriz de costes en el que cada fila establece una correlación con cada columna, dicho algoritmo buscará la \textbf{asignación óptima}, es decir, de menor coste entre elementos, en este caso, dos frames adyacentes \cite{Hungarian}. La figura \ref{fig:Seq} muestra un ejemplo de funcionamiento del método, que consiste en lo siguiente. Se aplica el modelo de detección pertinente y se generan las \glspl{bbox} del \textbf{frame actual y del siguiente}. Posteriormente, se genera la matriz de costes, donde las \glspl{bbox} del frame actual se encuentran en las filas y las \glspl{bbox} del frame posterior en las columnas. Para cada par de \glspl{bbox} de la matriz, se calcula el \textbf{\acrfull{iou}} \cite{iou}, esta métrica devuelve el porcentaje de solapamiento y similitud entre \glspl{bbox}, de forma que recortes de diferente tamaño (cuando más cerca esté el sujeto de la cámara, más grande será el recorte) den un valor bajo al solaparse (ejemplo: personas que coinciden en la imagen en diferentes distancias). Dadas dos \glspl{bbox} A y B, el \acrshort{iou} se calcula como sigue \ref{eq:iou}. Ya que el método húngaro busca las relaciones de menor coste, es necesario restar el valor obtenido por uno. Tras repetir el método en todos los frames de la secuencia, se agrupa la información de cada persona según el rastro generado por el algoritmo.

\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{imagenes/iou.png}
    \caption{Intersection over Union, imagen extraída de \cite{iou}}
    \label{fig:iou}
\end{figure}

\[ IoU = \frac{A \cap B}{A \cup B} \]
\captionof{figure}{Cálculo del \acrshort{iou}}
\label{eq:iou}

\subsubsection{Reidentificación de entidades}
Es posible que durante la detección, las \glspl{bbox} de una misma persona en frames consecutivos no se solapen debido a la velocidad de movimiento de la propia persona o a un movimiento de la cámara, lo que imposibilita la aplicación del método húngaro. Otro problema es el no seguimiento de la persona cuando esta se encuentra totalmente ocluida (ejemplo: se cruza un individuo justo delante) y reaparece o si simplemente la persona gira su cara fuera de la visión de la cámara y vuelve a detectarse después, en estos casos se crearía una nueva entidad para el mismo individuo, lo que no es un comportamiento deseable.

El \textbf{filtro de Kalman} predice la próxima posición del individuo a partir de la probabilidad Gausiana, de tal forma que puede mantenerse el rastro cuando la persona desaparece por unos frames. A pesar de ser una técnica efectiva, el filtro necesita de un mínimo de frames para converger cuando una nueva persona aparece \cite{MangoYOLO}, lo que no es beneficioso para intervalos de secuencia cortos. Finalmente se ha optado por un método más sencillo basado en la \textbf{distancia euclidiana}. En el caso de que haya un movimiento veloz del individuo o de la cámara, se calcula la distancia entre el \textbf{centro} de la \gls{bbox} actual con la \glspl{bbox} posterior que no tiene solape, si la distancia calculada es \textbf{inferior a un umbral}, \textbf{se valida la asociación}. En el caso de perder el rastro del individuo, se guarda la posición de la última aparición del mismo y se calcula la distancia con las \glspl{bbox} sin asociación en futuros frames, si la distancia no es inferior al umbral en un máximo de frames (prefijado por el operador), \textbf{se abandona el rastreo}, en caso contrario se restablece. El valor del umbral se fija de antemano \textbf{y se ajusta automáticamente en función de la resolución} de la cámara.

En la figura \ref{fig:eucls} se expone un ejemplo real, en el primer frame (figura \ref{fig:eucls}), se muestran dos entidades etiquetadas con un identificador (0 y 1) y como para la entidad 0 sus \glspl{bbox} no se solapan, en este caso la distancia euclidiana es capaz de mantener la identificación, también se muestra como la entidad 1 está a punto de ser ocluida, al no haber \glspl{bbox} en frames posteriores asociables a la entidad 1, la posición del sujeto se guarda. En el segundo frame (figura \ref{fig:eucls}), la entidad 1 se encuentra totalmente ocluida por la entidad 0, como en el instante posterior a dicho frame existe una \gls{bbox} sin ninguna asociación, se calcula la distancia euclidiana entre dicha \gls{bbox} respecto a la última detectada de la entidad 1. En el último frame (figura \ref{fig:eucls}) se muestra la entidad 1 reasignada.

\begin{figure}[hp!]
    \centering
    \begin{subfigure}[c]{0.2\textwidth}
        \includegraphics[width=\textwidth]{imagenes/eucl0.png}
    \end{subfigure}
    \begin{subfigure}[c]{0.2\textwidth}
        \includegraphics[width=\textwidth]{imagenes/eucl1.png}
    \end{subfigure}
    \begin{subfigure}[c]{0.2\textwidth}
        \includegraphics[width=\textwidth]{imagenes/eucl2.png}
    \end{subfigure}
    \caption{Reidentificación mediante la distancia euclidiana}
    \label{fig:eucls}
\end{figure}

\[ \Delta r_{euclid} = \sqrt{\Delta x^{2} + \Delta y^{2}} \]
\captionof{figure}{Cálculo de la distancia euclidiana en un sistema de coordenadas \acrshort{2d}, extraído de \cite{Hungarian}}
\label{eq:eucl}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/Seq.jpg}
    \caption{Funcionamiento del método húngaro para el seguimiento de personas, como salida se obtiene una lista de recortes agrupados por entidad}
    \label{fig:Seq}
\end{figure}

\section{Módulo adaptativo}

Tras agrupar las \glspl{bbox} por individuos y calcular sus vectores, se procesa dicha información para devolver las predicciones y actualizar el conocimiento existente ante los nuevos cambios que puedan surgir (módulo adaptativo figura \ref{fig:finalsys}). En la figura \ref{fig:ADAPTSYS} se muestra la arquitectura de este módulo, cuyos componentes se han diseñado partiendo de \cite{Erik, CESAR} como referencia. El módulo recibe una lista de vectores agrupados por individuos, que se comparan contra la base de datos de personas registradas para averiguar si dichos sujetos pertenecen o no al sistema. La base de datos está compuesta por \textbf{comités (o colecciones) de \acrshort{svm}} por cada individuo. Se ha demostrado que múltiples \acrshort{svm} simples (ejemplo: lineales) como conjunto (\textbf{comité}) \textbf{generalizan mejor} que una única \acrshort{svm} compleja (ejemplo: sigmoide) \cite{malisiewicz2011ensemble}. Los comités de \acrshort{svm} también favorecen la adaptación a los cambios, ya que permiten agregar conocimiento acerca de una entidad entrenando una nueva \acrshort{svm} lineal o eliminar dicho conocimiento descartando la \acrshort{svm} correspondiente. De esta forma, se obtiene una representación de un individuo a partir de un conjunto de modelos ligeros, sin necesidad de reentrenar un modelo complejo desde cero \cite{malisiewicz2011ensemble}.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/ADAPTSYS.jpg}
    \caption{Diseño del módulo adaptativo}
    \label{fig:ADAPTSYS}
\end{figure}

TODO: las \acrshort{svm}, ya que por si solas no son capaces de discernir fuera del conjunto de datos con las que fueron entrenadas (\textit{Closed-Set}), por lo que un dato desconocido se clasificaría erróneamente como una de las clases del entrenamiento \cite{rudd2017extreme}

Para tomar la decisión de si un sujeto es o no un desconocido, se ha implementado un algoritmo basado en el teorema estadístico \acrfull{evt} o teorema de Fisher–Tippett–Gnedenko que permite \textbf{detectar extremos} en distribuciones estadísticas. Siendo \textit{f(x)} la distribución de puntuaciones \textbf{que no corresponden con el sujeto}, se analiza si el comité que se corresponde supuestamente con el sujeto es un \textbf{extremo} de la distribución \textit{f(x)}, por lo tanto la entidad se reconoce claramente diferenciada con el resto, en caso contrario, se denota como desconocido. El \acrfull{evt} dicta que la distribución de los valores máximos o mínimos sigue una de las siguientes 3 distribuciones: Gumbel, Frechet, Weibull \cite{rudd2017extreme, scorenorm, Erik}. Gumbel y Frechet son distribuciones \textbf{no acotadas}, mientras que Weibull es una distribución acotada. Para sistemas de reconocimiento que calculan las distancias o similitudes entre puntuaciones (ejemplo: valores devueltos por una \acrshort{svm} para una clase), la distribución de puntos para cada clase sigue una distribución de Weibull, ya que los valores se encuentran acotados \cite{scorenorm}. El \acrshort{evt} otorga un conocimiento robusto, ya que convierte puntuaciones (o scores) concretos de un algoritmo (en este caso las \acrshort{svm}) en probabilidades que siguen una teoría estadística. Esto permite la \textbf{fusión de datos de diferentes fuentes} como nuevas redes de reconocimiento o nuevas cámaras diferentes a las Kinect en el sistema \cite{scorenorm}.

La distribución de Weibull se modela a partir de las puntuaciones devueltas por cada comité (salida de la función EDF en la figura \ref{fig:ADAPTSYS}) \textbf{excepto la mejor puntuación} de todos los \textit{ensembles} (que se corresponde con la más baja). Debido a que la entidad en cuestión solo puede coincidir con un comité, se comprueba si el mejor resultado (o lo que se presupone la entidad de la secuencia) \textbf{es un extremo} respecto de la distribución de puntuaciones no coincidentes (resto de \textit{ensembles}), en caso afirmativo, se asigna la etiqueta del usuario del comité con la mejor puntuación, en caso contrario, el individuo se considera \textbf{desconocido} (no coincide con ningún comité). Para determinar si la puntuación es un extremo, se obtiene la probabilidad a partir de la \acrfull{pdf} del mejor score con los parámetros obtenidos de la distribución de Weibull modelada. Si la probabilidad se encuentra por debajo de un umbral (Tw), la puntuación se considera que está \textbf{al extremo de la distribución} \cite{scorenorm}.

Según la entidad predecida, se toma una cierta decisión de actualización. Si el sujeto es desconocido, se crea un nuevo comité con una \acrshort{svm} que se añade al registro (update module en la figura \ref{fig:ADAPTSYS}), la \acrshort{svm} se entrena con las muestras (\textit{\gls{embedding}} de caras o cuerpos) obtenidas del propio sujeto como conjunto de positivos, mientras que el conjunto de negativos se compone de muestras aleatorias extraídas de la base de datos. Si el sujeto es conocido, se agrega una nueva \acrshort{svm} al comité, entrenada con las muestras del propio individuo como positivos y como negativos un muestreo aleatorio de todas las entidades \textbf{excepto el propio sujeto}. Si el comité alcanza el límite máximo de \acrshort{svm}, se ejecuta un algoritmo que elimina el clasificador que menos aporte (limitation module en la figura \ref{fig:ADAPTSYS}).

Finalmente, el módulo adaptativo devuelve la predicción realizada al nodo integración de sensores, que se corresponde con un individuo detectado por una de las cámaras.
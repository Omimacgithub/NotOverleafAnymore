\chapter{Implementación del sistema}
\label{chap:impl}

\lettrine{E}{n} este capítulo se ahonda en los fundamentos y detalles de implementación de la funcionalidad \textit{Open-World} y demás componentes para otorgar la adaptación.

%\section{Fundamentos}
%\label{subsec:erikfounds}

TODO: El método propuesto en \cite{Erik} y que conforma la base del sistema implementado, ha sido probado en un contexto de video vigilancia bajo el \textit{\gls{dataset}} \textbf{FACE COX} \cite{cox}. También se ha utilizado el \textit{\gls{dataset}} \textbf{Youtube Faces} (YTF) \cite{ytf} que, a diferencia del anterior, se encuentra accesible de forma pública. En este proyecto se utiliza un \textit{\gls{dataset}}\dots
El método utiliza \textbf{secuencias de video} como entrada para devolver las predicciones acerca de un IoI o para determinar una identidad desconocida.

La figura \ref{fig:FITS}.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{imagenes/FITS.jpg}
    \caption{Ejemplos de distribuciones del \acrshort{evt} y como el umbral (Tw) distingue entre un desconocido (\textit{unknown} y una deriva (\textit{drift})).}
    \label{fig:FITS}
\end{figure}

\section{Capacidad de adaptación}
\label{sec:adapt}

\subsection{Inicialización}

TODO: figura?

En esta primera fase del sistema se crean los registros que representarán a los individuos iniciales. En este proyecto se han probado 2 aproximaciones:
\begin{itemize}
    \item \textbf{Supervisado}: el operador realiza una selección de los frames más representativos para cada individuo.
    \item \textbf{No supervisado}: el sistema recoge los frames cuando aparecen un mínimo de 5 entidades simultaneas en escena (el mínimo necesario de puntos para poder aplicar Weibull). A partir de los frames de las cámaras, que estarán sincronizadas, se obtienen las \glspl{bbox} que encierran los rostros y se procede a la creación de los comités con los recortes de caras generados. \textbf{No se requiere de ninguna intervención del operador}, el sistema realiza la selección en base a unos criterios preestablecidos (ejemplo: la cara debe estar completamente dentro del rango de la cámara). En esta aproximación, es crucial el método de seguimiento (tracking) para recolectar las secuencias de caras.
\end{itemize}

Independientemente de la aproximación escogida, se obtienen las características de cada frame de la secuencia y se crea la \acrshort{svm} inicial con la que se \textbf{inicializa el comité}. Dicha \acrshort{svm} se entrena con las características del usuario, que compondrá el set positivo, y un subconjunto de las características del resto de usuarios, que compondrá el set de negativos (escogidas aleatoriamente). Dichas características son generadas por el modelo ArcFace \cite{deng2019arcface}, es la misma red que se utiliza en \cite{Erik, andrew} y que ha demostrado ser de las mejores en el \acrshort{sota} del reconocimiento facial.

La \acrshort{svm} inicial es la que define la identidad del comité. Si dicha \acrshort{svm} está compuesta por recortes de caras de baja calidad (ejemplo: borrosas o parcialmente ocluidas), entonces el comité \textbf{no estará bien definido} y, por lo tanto, generará \textbf{mayor confusión} a la hora de aplicar Weibull para los reconocimientos.

El resto de módulos del sistema que se exponen a continuación se ejecutan por cada secuencia de caras recolectada en cada secuencia de frames (figura \ref{fig:FACESYS}).

\subsection{\textit{Ensemble Decision Function} (EDF)}

Es el módulo encargado de devolver una representación comparable de cada individuo que será aplicada en la decisión de reconocimiento.

Por cada secuencia de entrada, siendo esta una secuencia de \textit{\glspl{embedding}} extraídas de los recortes faciales (figura \ref{fig:FACESYS}), se calculan las \textbf{puntuaciones (scores) para cada comité}. La puntuación de un comité es a su vez un valor consensuado entre los resultados de las predicciones de las \acrshort{svm} que lo conforman, el criterio de consenso (o de fusión) se basa en un percentil (generalmente la media). Aplicar percentiles es igual a escoger un conjunto amplio o reducido de \acrshort{svm}, ya que pueden existir \acrshort{svm} dañinas para el comité (ejemplo: corresponden a otra persona), los percentiles ayudan a descartar los resultados de dichas \acrshort{svm}. Para cada comité, se ejecutan las siguientes funciones:
\begin{itemize}
    \item \textbf{FDF} (Frame Decision Function): se calculan los scores de cada \acrshort{svm} contra \textbf{un frame} de la secuencia y se fusionan las salidas (o puntuaciones) en una única puntuación del comité para dicho frame. Antes de la fusión, se aplica la normalización Euclidiana (figura \ref{eq:l2norm}) a cada puntuación con el fin de hacerlas comparables.
    \item \textbf{SDF} (Sequence Decision Function): se encarga de fusionar todas las puntuaciones de la anterior función para obtener un único resultado que representa a la \textbf{secuencia}.
\end{itemize}

\[ s_{i} = \frac{x_{i}}{\left\| x_{i}\right\|_{2}} \]
\captionof{figure}{Normalización L2, siendo $x_{i}$ un \textit{\gls{embedding}} o la salida de una \acrshort{svm}, se obtiene el vector normalizado $s_{i}$.}
\label{eq:l2norm}

\subsection{\textit{Recognition Decision Function} (RDF)}
Esta función determina si la entidad detectada se corresponde a un individuo previamente reclutado o a una entidad \textbf{desconocida}.

(TODO: va en fundamentos) Las \acrshort{svm} sólo pueden discernir dentro del conjunto de datos con las que fueron entrenadas (\textit{Closed-Set}), por lo que un dato desconocido se clasificaría erróneamente como una de las clases del entrenamiento \cite{rudd2017extreme}. Varias investigaciones \cite{rudd2017extreme, scorenorm} y la propia tesis de referencia \cite{Erik} utilizan el \textbf{\acrfull{evt}} o teorema de Fisher–Tippett–Gnedenko para identificar clases no reclutadas. El \acrshort{evt} determina que el conjunto de máximos o mínimos de una muestra sigue una distribución de \textbf{Weibull}. El \acrshort{evt} otorga un conocimiento robusto, ya que convierte scores concretos de un algoritmo (en este caso las \acrshort{svm}) en probabilidades que siguen una teoría estadística. Esto permite la \textbf{fusión de datos de diferentes fuentes} como nuevas redes de reconocimiento o nuevas cámaras diferentes a las Kinect en el sistema.

La distribución de Weibull se modela a partir de las puntuaciones devueltas por cada comité (salida de la función EDF) \textbf{excepto la mejor puntuación} de todos los \textit{ensembles} (que se corresponde con la más baja). Debido a que la entidad en cuestión solo puede coincidir con un comité, se comprueba si el mejor resultado (o lo que se presupone la entidad de la secuencia) \textbf{es un extremo} respecto de la distribución de puntuaciones no coincidentes (resto de \textit{ensembles}), en caso afirmativo, se asigna la etiqueta del usuario del comité con la mejor puntuación, en caso contrario, el individuo se considera \textbf{desconocido} (no coincide con ningún comité). Para determinar si la puntuación es un extremo, se calcula la probabilidad (\gls{pdf}) del mejor score a partir de la función \gls{pdf} con los parámetros obtenidos de la distribución de Weibull modelada. Si el \gls{pdf} se encuentra por debajo de un umbral (Tw), la puntuación se considera que está \textbf{al extremo de la distribución} \cite{scorenorm}.

TODO: El algoritmo compone una función de Weibull ajustando los parámetros de la misma para que converga con la cola de la distribución. Dicha distribución está formada por las distancias de cada puntuación con la mediana, excluyendo la puntuación más baja (siendo teóricamente la puntuación que coincide para la entidad) y las puntuaciones por encima de la mediana. Finalmente, se determina la probabilidad de pertenencia de la puntuación más baja de la distribución, si la probabilidad es lo suficientemente baja como para concluir que no pertenece a la distribución, entonces el reconocimiento es correcto y se asigna la entidad. En caso contrario, se concluye que la entidad es desconocida. Se establece un threshold (Tw, como se muestra en el algoritmo \ref{coud:weib}).

\input{contenido/codes/weib}

\subsection{Update Module}
Es el módulo que implementa la actualización de los comités tras el reconocimiento realizado en la anterior función. Dado un valor c, siendo este el resultado de la función RDF, pueden darse los siguientes dos escenarios:
\begin{itemize}
    \item \textbf{Entidad conocida (c<Tw)}: se crea una nueva \acrshort{svm} que
          será incluida en el comité ganador (el que tiene la puntuación más baja).
          La \acrshort{svm} se entrena con los \textit{\glspl{embedding}} de la secuencia de entrada como
          conjunto de positivos. Como conjunto de negativos, se realiza un muestreo aleatorio de \textit{\glspl{embedding}} \textbf{del resto de comités}.
    \item \textbf{Entidad desconocida (c>Tw)}: se crea una \acrshort{svm} en un nuevo comité representando a la entidad.
          El conjunto de positivos es el mismo que en el caso anterior. En el caso de los negativos,
          las muestras de cualquier comité son válidas.
\end{itemize}

Una condición necesaria para que este módulo se ejecute es que la
secuencia de entrada para el individuo \textbf{contenga un mínimo de frames para su inicialización},
dicho mínimo es fijado por el operador de antemano. Otra precondición,
que aplica a las entidades conocidas, es comprobar si las caras (o muestras) a añadir son lo suficientemente representativas.
Las puntuaciones cerca del cero indican que las muestras se encuentran en el borde de lo que es nuevo y lo que la \acrshort{svm}
ya conoce. A partir de un valor de umbral (\textit{update\_th}) se decide si dichas muestras añaden información nueva al comité.

\textbf{El tamaño del conjunto de positivos y de negativos es prefijado por el operador.}

\subsection{Limitation Module}
\label{seq:limmod}

El limitation module es una función que se encuentra inherente al módulo de actualización. Si un comité excede un número prefijado de \acrshort{svm} almacenadas, se toma una decisión para eliminar una de las \acrshort{svm} según los siguientes criterios:
\subsubsection{Diversidad}
Este criterio mide el valor de aportación de una \acrshort{svm} respecto al resto del comité. Se coge un conjunto aleatorio de n \textit{\glspl{embedding}} (siendo n=50) de entre todos los comités y se generan los scores utilizando las m \acrshort{svm} del comité, lo que resulta en n*m scores. TODO: \textbf{Basándose en el signo de los scores}, se acumula el producto de los signos entre scores, de forma que un valor discordante afecta en mayor medida a la propia \acrshort{svm} y en menor medida al resto de \acrshort{svm}. Un valor alto indica bajo nivel de diversidad, por ende un valor \textbf{pobre de aportación al comité}. La figura \ref{fig:diversity} muestra la fórmula de diversidad, que se calcula como en \cite{Erik}.

\begin{figure}
    \centering
    \includegraphics[width=0.75\linewidth]{imagenes/Diversity.png}
    \caption{Fórmula de diversidad, extraída de \cite{Erik}}
    \label{fig:diversity}
\end{figure}

\subsubsection{Coherencia}
Este criterio viene a determinar la precisión de una \acrshort{svm} en el reconocimiento cuando no se dispone de un \textit{\gls{dataset}} para su evaluación (ejemplo: entorno operacional). El valor de coherencia determina cuantas veces una \acrshort{svm} devuelve el mismo signo que el resultado consensuado del comité, si los signos coinciden, se suma 1 al valor de coherencia, en caso contrario, se resta -1 a dicho valor. Un valor alto indica buena precisión. En la creación de una \acrshort{svm}, este valor se inicializa a 0.

\subsubsection{Favorabilidad}
Finalmente, los dos criterios se fusionan en un valor llamado \textbf{índice de favorabilidad}, la \acrshort{svm} con el menor valor de dicho índice \textbf{se elimina del comité}. El signo del valor de diversidad \textbf{se invierte} a la hora de la fusión.

\subsection{Creación de nuevos comités (\textit{Open-World})}
Cuando se reconoce a un usuario como desconocido (supuestamente un individuo no antes reclutado), se registra su identidad en forma de un nuevo comité con una \acrshort{svm} inicial. De esta forma, el sistema adquiere la capacidad de expandir su conocimiento a partir de personas nunca antes vistas. Dicha \acrshort{svm} inicial tiene de muestras positivas las de la propia secuencia actual y de muestras negativas las del resto de individuos ya conocidos.

\section{Mejoras del sistema base}

\subsection{Escalabilidad y tolerancia a fallos de las cámaras}
Cuando se fusionan los resultados procesados por los distintos sensores, se requiere que todos ellos se encuentren \textbf{sincronizados} dentro de un intervalo temporal (ejemplo: 100 milisegundos), de forma que las predicciones no se empañan de información desactualizada. En \cite{andrew} se utiliza una librería (TODO: clase) de \acrshort{ros}, llamada \textit{ApproximateTimeSynchronizer}, esta librería utiliza un algoritmo para emparejar mensajes a partir del \gls{timestamp} \cite{ApproximateTime}. El problema de esta librería es que no es flexible, ya que espera recibir datos de todas las fuentes en todo momento, lo que no es un suceso realista y que puede provocar una caída del sistema en el momento que una cámara falle. Como solución a este problema, se ha empleado la clase \textit{MessageFiltersCache} de la misma librería a modo de sustitución (TODO: ref). En esta nueva implementación, cada nodo posee una caché en la que se almacenan los mensajes, a una frecuencia establecida se recuperan los datos de todas las cachés, TODO: si en una de las cachés el último dato no se corresponde con el intervalo actual, este se descarta.

\subsection{Migración a ROS 2}
\label{subsec:ROS2}

Con el motivo del fin de soporte de ROS 1 \cite{ROSEOL}, se ha optado por migrar el sistema para ser ejecutado en ROS 2 con el fin de mantener su continuidad. La documentación oficial de \acrshort{ros} proporciona una guía de migración \cite{ros2tuto}. Se han migrado los nodos cámara e integrador, la migración del nodo \acrshort{lidar} requeriría actualizar el código a una versión soportada para Ubuntu 22.04 de la librería pcl, entre otros detalles que llevarían a rediseñar casi todo el código. Por último, el sensor \acrshort{lidar} instalado no es compatible con \acrshort{ros} 2, lo que impide la migración a menos que se haga un recambio.  TODO: Se probaron diferentes alternativas como RoboStack.